# debezium-dag-docs
docs for debezium dag
Даг для репликации таблиц из исходных баз данных в Clickhouse
#### Table of contents
___
1. schema
2. dag run parameters
3. dag flow
4. tables
5. main entitites
6. ошибки и исправление
7. чего не хватает (маппинги, механика за происходящим, про тех поля таблиц)
#### Schema
___
<img width="11463" height="7494" alt="Frame 1002 (6)" src="https://github.com/user-attachments/assets/faa37723-3e32-4afc-9e32-6fb31560c891" />
*В исходной БД происходят изменения, debezium подключён к журналам транзакций и читает эти события. Каждое событие debezium превращает в сообщение и сохраняет в соответствующий Kafka-топик. Из топиков данные сохраняются в ClickHouse*

#### Dag run parameters
___
Даг принимает следующие параметры:
- **debezium_conn_id** - подключение к Debezium
- **clickhouse_conn_id** - подключение к ClickHouse
- **debezium_clickhouse_conn_id** - подключение Debezium к ClickHouse
- **debezium_source_conn_id** - подключение Debezium к исходной бд
- **source_conn_id** - подключение к исходной бд
- **source_conn_local_id** - подключение к локальной исходной бд
- **kafka_conn_id** - подключение к Kafka (основной) 
- **kafka_conn_local_id** - подключение к Kafka (локальный) 
- **debezium_connector_name** - имя Debezium коннектора 
- **tables** - список таблиц для репликации (через запятую) 
- **send_receive_timeout** - таймаут отправки и получения данных при вставке ретро-данных в таблицу ClickHouse
- **generation_type** - тип генерации (по дефолту KAFKA_CONNECT, DEBEZIUM depricated)
- **max_concurrent_workers** - количество параллельных рабочих процессов для создания таблиц
- **check_replication_lag** - если значение `true` и задержка репликации (`replication lag`) превышает `max_wait_replication_lag_seconds`, то таблицы не будут реплицированы в ClickHouse
#### Dag flow
___
1.  Проверка существования таблицы в исходной базе данных
	Проверяет наличие таблицы в исходной базе данных, что таблица не является view, а так же чтобы таблица не была в списке запрещенных для пересоздания таблиц *blocked_tables* (задается в скрипте самого дага)
2. Replication lag wait
3. Проверка существования схемы для таблиц в Clickhouse, создание схемы в случае ее отсутствия

4. Обновление конфигурации source коннектора, добавление туда таблицы через HTTP API
5. Обновление коннектора
6. Рестарт коннектора

7. Repoint
	Проверяется существование финальной вью, \_debezium таблицы, \_debezium_old таблицы.
	Если таблица \_debezium_old уже существует, значит предыдущий репоинт не был завершен корректно. Если фин вью и \_debezium существуют, а \_debezium_old нет, то \_debezium переименовывается в \_debezium_old, финальная вью пересоздается со ссылкой на \_debezium_old таблицу. Так обеспечивается доступ к данным пока отрабатывает даг
8. Запрос к информационной таблице исходной базы данных, чтобы извлечь метаданные о колонках реплицируемой таблицы и ключах
9. Применение мапперов (описать подробнее)
10. Удаление таблиц \_debezium, \_debezium_mv, \_changes если существуют
11. создание таблиц  \_debezium, \_debezium_mv, \_changes

12. Обновление конфигурации sink коннектора, добавление туда кафка-топика реплицируемой таблицы (описать подробнее создание топика)
13. Обновление коннектора
14. Рестарт коннектора

15. Replication lag wait
16. Initial load
	Загрузка существующих данных из source бд в Сlickhouse в таблицу \_debezium с помощью табличной функции
17. Создание финального view from \_debezium
18. Удаление \_debezium_old таблицы
#### Tables
___
Даг создает 4 таблицы через которые проходят данные:
<img width="7806" height="1685" alt="Frame 1003" src="https://github.com/user-attachments/assets/c00f58fa-4c14-4e01-8e7d-82504ea51fa5" />

##### \_changes
**type**: Table
**engine**: Null
В первую очередь данные попадают в таблицу \_changes, это триггерит срабатывание view \_debezium_mv, в самой таблице \_changes данные не хранятся.
В таблице есть поля `before_`, `after_` - состояния строк до/после операции, и поле `op` - тип операции.
При наличии новых колонок в исходной таблице метод `_build_alter_audit_changes_table_clause` сгенерирует `ALTER TABLE ... ADD COLUMN ...`

##### \_debezium_mv
**type**: View
Вью обрабатывает входящие изменения строк из таблицы \_changes, помечает удаленные строки в поле `is_deleted` и записывает строки в таблицу \_debezium

##### \_debezium
**type**: Table
**engine**: ReplicatedReplacingMergeTree (может быть переопределён маппером)
Отфильтровывает удаленные строки, удаляет дубликаты

##### final view
**type**: View
Финальная вью для запросов и аналитики

#### Main entities
___
*тут кратко про основные сущности процесса, сорс бд, аналитическая бд, топик, бинлог и тд и тп*

#### Errors and exceptions
___
*тут про ошибки которые встречались и их решение*
